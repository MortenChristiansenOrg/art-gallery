name: PR Pipeline

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  checks:
    runs-on: blacksmith-2vcpu-ubuntu-2025
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run tsc -b
      - run: bun run test:coverage
      - run: bunx vite build
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

  e2e:
    runs-on: blacksmith-2vcpu-ubuntu-2025
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bunx playwright install --with-deps
      - run: bun run e2e
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/

  preview:
    runs-on: blacksmith-2vcpu-ubuntu-2025
    needs: checks
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install

      - name: Deploy Convex preview
        id: convex
        run: |
          OUTPUT=$(bunx convex deploy --preview "pr-${{ github.event.pull_request.number }}" 2>&1)
          echo "$OUTPUT"
          URL=$(echo "$OUTPUT" | grep -oP 'https://[^\s]*\.convex\.cloud')
          echo "url=$URL" >> "$GITHUB_OUTPUT"
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Deploy Vercel preview
        id: vercel
        run: |
          URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --build-env VITE_CONVEX_URL=${{ steps.convex.outputs.url }})
          echo "url=$URL" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
